#!/bin/sh -eu

bootstrapped=.bootstrapped

if [ ! -f "$bootstrapped" ]; then
    createuser \
         -h "${PG_HOST}" \
         -p "${PG_PORT}" \
        "${PG_USER_HEALTHCHECK}" || true
    
    createdb \
         -h "${PG_HOST}" \
         -p "${PG_PORT}" \
        "${PG_USER_HEALTHCHECK}" || true
    
    psql \
        -h "${PG_HOST}" \
        -p "${PG_PORT}" \
        -U "${PG_USER_HEALTHCHECK}" \
        -d "${PG_USER_HEALTHCHECK}" \
        -c 'CREATE TABLE ping (t_ins timestamptz NOT NULL DEFAULT now())' ||
    true
fi

(
    psql \
        -h "${PG_HOST}" \
        -p "${PG_PORT}" \
        -U "${PG_USER_HEALTHCHECK}" \
        -d "${PG_USER_HEALTHCHECK}" \
        -c 'INSERT INTO ping VALUES (DEFAULT)' &&
    touch "$bootstrapped"
) ||
[ ! -f "$bootstrapped" ]
